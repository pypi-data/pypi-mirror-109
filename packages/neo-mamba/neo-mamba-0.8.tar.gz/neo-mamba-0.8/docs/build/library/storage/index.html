
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Storage &#8212; neo-mamba  documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/neo3.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Virtual Machine" href="../vm/index.html" />
    <link rel="prev" title="Convenient syncing" href="../network/convenience.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../vm/index.html" title="Virtual Machine"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../network/convenience.html" title="Convenient syncing"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">neo-mamba  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">The neo-mamba Library</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Storage</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="storage">
<span id="library-storage-index"></span><h1>Storage<a class="headerlink" href="#storage" title="Permalink to this headline">¶</a></h1>
<p>This chapter gives a high level overview of the storage layer and its usage.</p>
<p>The storage layer provides a generic interface for persisting and retrieving common blockchain data. It is a tradeoff between having a developer friendly interface and providing the means necessary for the interoperability layer and smart contract execution.</p>
<p>Two backend implementations, In-Memory and LevelDB, are part of this SDK with the posibility to implement custom ones by implementing a set of interfaces. For more information on implementing alternative backends see this <a class="reference internal" href="../../howto/backends.html#backends-howto"><span class="std std-ref">HOWTO</span></a>.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>There are four main storage topics that this layer takes care of</p>
<ol class="arabic simple">
<li><p>Blocks</p></li>
<li><p>Transactions</p></li>
<li><p>(Smart) contracts</p></li>
<li><p>Smart contract storage</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">contracts</span></code> topic stores the generic data related to the actual smart contract; its code and a manifest with contract permissions and the <a class="reference external" href="https://github.com/neo-project/proposals/blob/master/nep-3.mediawiki">ABI</a>. The <code class="docutils literal notranslate"><span class="pre">smart</span> <span class="pre">contract</span> <span class="pre">storage</span></code> covers individual smart contract storages. i.e. balances for a NEP-17 contract.</p>
<p>Before we learn how to access the information of the individual topics, let us first get an idea of the different ways data can be accessed in general.</p>
<img alt="../../_images/storage_overview.png" class="align-center" src="../../_images/storage_overview.png" />
<p>A database object has two views.</p>
<ol class="arabic simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">RawView</span></code> for direct access to the backend. Any changes through the put/update/delete operations are instantly persisted.</p></li>
<li><p>A second view called <code class="docutils literal notranslate"><span class="pre">SnapshotView</span></code> creates a snapshot of the current database state and provides cached access. This copy can be freely operated on withoutout having to fear accidental modification of the underlying data. A <cite>commit()</cite> action is required to persist the changes to the real backend.</p></li>
</ol>
<p>One might wonder why caching is present when many backends have their own (and likely better) caching mechanism. The caching layer is there not just to provide “improved” access speeds, but more importantly to provide a generic way to clone state, operate on the state, and discard and rollback the state under certain conditions.</p>
<p>The main use-case for these requirements are block processing. All transactions in a block are executed by the NEO virtual machine. Such transactions can include transformations to smart contract storages (like a NEP-17 balance). If after a certain amount of storage transformations an error occurs (e.g. because the user reached his balance limit) then all transformations need to be discarded/rolled back to the starting state. Instead of forcing each backend implementation to create their own mechanism, a generic one is in place to handle this for you.</p>
</div>
<div class="section" id="accessing-data">
<h2>Accessing data<a class="headerlink" href="#accessing-data" title="Permalink to this headline">¶</a></h2>
<p>As described in the overview we have four main topics of data (blocks, contracts, storages and transactions) in our data store. Each topic can be accessed via a property on the database object. The following example accesses the smart contract storage topic</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">neo3.core</span> <span class="kn">import</span> <span class="n">types</span>
<span class="kn">from</span> <span class="nn">neo3.storage</span> <span class="kn">import</span> <span class="n">implementations</span>
<span class="kn">from</span> <span class="nn">neo3.storage</span> <span class="kn">import</span> <span class="n">StorageKey</span><span class="p">,</span> <span class="n">StorageItem</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Prepare some data</span>

    <span class="c1"># Dummy contract id for demonstration purposes</span>
    <span class="n">contractid</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">key1</span> <span class="o">=</span> <span class="n">StorageKey</span><span class="p">(</span><span class="n">contractid</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;key1&#39;</span><span class="p">)</span>
    <span class="n">key2</span> <span class="o">=</span> <span class="n">StorageKey</span><span class="p">(</span><span class="n">contractid</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;key2&#39;</span><span class="p">)</span>
    <span class="n">value1</span> <span class="o">=</span> <span class="n">StorageItem</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;value1&#39;</span><span class="p">)</span>
    <span class="n">value2</span> <span class="o">=</span> <span class="n">StorageItem</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;value2&#39;</span><span class="p">)</span>

    <span class="c1"># Create a database instance</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">implementations</span><span class="o">.</span><span class="n">MemoryDB</span><span class="p">()</span>

    <span class="c1"># Create a direct access view</span>
    <span class="n">raw_view</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_rawview</span><span class="p">()</span>

    <span class="c1"># Persist data to the (smart contract) storages topic in the backend.</span>
    <span class="n">raw_view</span><span class="o">.</span><span class="n">storages</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="n">value1</span><span class="p">)</span>
    <span class="n">raw_view</span><span class="o">.</span><span class="n">storages</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">key2</span><span class="p">,</span> <span class="n">value2</span><span class="p">)</span>

    <span class="c1"># Query the data</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">raw_view</span><span class="o">.</span><span class="n">storages</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">contract_id</span><span class="o">=</span><span class="n">contractid</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Each topic has the common <code class="docutils literal notranslate"><span class="pre">add</span></code>, <code class="docutils literal notranslate"><span class="pre">put</span></code>, <code class="docutils literal notranslate"><span class="pre">delete</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code> and <code class="docutils literal notranslate"><span class="pre">all</span></code> methods. Certain topics have additional specialized methods like <code class="docutils literal notranslate"><span class="pre">get_by_height()</span></code> for the <code class="docutils literal notranslate"><span class="pre">blocks</span></code> topic (as opposed to the default by-hash) to improve the developer experience. Check out the interfaces for each topic below.</p>
<p>Let us extend the previous example with the code below to demonstrate the snapshot mechanism.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">key3</span> <span class="o">=</span> <span class="n">StorageKey</span><span class="p">(</span><span class="n">contractid</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;key3&#39;</span><span class="p">)</span>
<span class="n">value3</span> <span class="o">=</span> <span class="n">StorageItem</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;value3&#39;</span><span class="p">)</span>
<span class="n">snapshot_view</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_snapshotview</span><span class="p">()</span>

<span class="n">snapshot_view</span><span class="o">.</span><span class="n">storages</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">key3</span><span class="p">,</span> <span class="n">value3</span><span class="p">)</span>

<span class="c1"># Query the data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Snapshot data&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">raw_view</span><span class="o">.</span><span class="n">storages</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">contract_id</span><span class="o">=</span><span class="n">contractid</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Backend data - without snapshot data&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">raw_view</span><span class="o">.</span><span class="n">storages</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">contract_id</span><span class="o">=</span><span class="n">contract_id</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

<span class="c1"># Now persist to the backend</span>
<span class="n">snapshot_view</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Backend data - updated&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">raw_view</span><span class="o">.</span><span class="n">storages</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">contract_id</span><span class="o">=</span><span class="n">contract_id</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">


  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Storage</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#accessing-data">Accessing data</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../network/convenience.html"
                        title="previous chapter">Convenient syncing</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../vm/index.html"
                        title="next chapter">Virtual Machine</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/library/storage/index.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../vm/index.html" title="Virtual Machine"
             >next</a> |</li>
        <li class="right" >
          <a href="../network/convenience.html" title="Convenient syncing"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">neo-mamba  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >The neo-mamba Library</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Storage</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019-2021, COZ - Erik van den Brink.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.2.
    </div>
  </body>
</html>