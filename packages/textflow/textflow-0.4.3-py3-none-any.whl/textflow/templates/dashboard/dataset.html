{% raw %}
<script id="dataset-section-template" type="text/x-handlebars-template">
    <div class="field is-horizontal">
        <div class="field-body">
            <div class="field w-100">
                <label for="dataset-select" class="label">Dataset</label>
                <div class="control">
                    <div class="select w-100">
                        <select class="input" id="dataset-select">
                            {{#each data.datasets}}
                            <option>{{ this }}</option>
                            {{/each}}
                        </select>
                    </div>
                </div>
            </div>
            <div class="field w-100">
                <label for="validator-select" class="label">Validator</label>
                <div class="control">
                    <div class="select w-100">
                        <select class="input" id="validator-select">
                            {{#each data.groups}}
                            <option>{{ this }}</option>
                            {{/each}}
                        </select>
                    </div>
                </div>
            </div>
            <div class="field">
                <label class="label">â €</label>
                <div class="control is-flex is-justify-content-flex-end">
                    <button id="download-dataset-button" class="button is-link" style="min-width: 8em;">Download</button>
                </div>
            </div>
        </div>
    </div>
</script>
{% endraw %}

<!--suppress JSUnresolvedVariable -->
<script>
    templates.add('dataset', function () {
        let source = document.getElementById("dataset-section-template").innerHTML;

        let template = Handlebars.compile(source);

        let data = {};

        let methods = {
            saveAs: function (content, filename) {
                const blob = new Blob([JSON.stringify(content, null, 2)], {type: 'application/json'})
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.download = filename;
                a.href = url;
                a.click();
            },
            download: function (event) {
                let args = '';
                if (data.validator !== '') args += 'validator=' + data.validator;
                if (args !== '') args = '?' + args;
                $.get('/api/projects/{{ project_id }}/datasets/download' + args)
                    .then((payload) => {
                        if (payload['status'] === 'success') {
                            const fn = data.selectedDataset + '_' + data.validator + '.json';
                            this.saveAs(payload.data, fn);
                        }
                    });
            },
        }

        function render(id) {
            $.get('{{ url_for('dashboard.get_dataset_names', project_id=project_id) }}').then((payload) => {
                    data.datasets = payload.data;
                    data.selectedDataset = payload.data[0];
                    let args = '';
                    if (this.validator !== '') args += 'name=' + data.selectedDataset;
                    if (args !== '') args = '?' + args;
                    $.get('{{ url_for('dashboard.get_group_names', project_id=project_id) }}' + args)
                        .then((payload) => {
                            data.groups = payload.data;
                            data.validator = 'sys.majority';
                            let container = document.getElementById(id);
                            container.innerHTML = template({data})
                            let downloadButton = document.getElementById('download-dataset-button')
                            downloadButton.addEventListener('click', () => {
                                methods.download();
                            });
                            let datasetSelect = document.getElementById('dataset-select');
                            datasetSelect.addEventListener('change', () => {
                                data.selectedDataset = datasetSelect.value;
                            });
                            let validatorSelect = document.getElementById('validator-select');
                            validatorSelect.addEventListener('change', () => {
                                data.validator = validatorSelect.value;
                            });
                        })
                }
            );
        }

        return {render}
    })
</script>